pipeline {
    agent {
        docker {
            image 'node:alpine'
            args '-u root'
        }
    }
 
    stages {
        stage('init') {
            steps {
                sh '''
                    apk update && apk add git
                    npm install --save-dev @commitlint/config-conventional @commitlint/cli
                    git config --global --add safe.directory $PWD
                    echo 'module.exports = {extends: ["@commitlint/config-conventional"]};' > commitlint.config.js
                '''
            }
        }
 
        stage('Validate Commit Message') {
            steps {
                script {
                    sh 'npx commitlint -f $GIT_PREVIOUS_COMMIT -t $GIT_COMMIT --verbose'
                }
            }
        }
    }
    post {
        always {
            // Cleanup
            cleanWs()
        }
    }
}