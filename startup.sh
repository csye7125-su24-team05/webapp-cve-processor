#!/bin/bash

# Function to check the readiness of the sidecar
check_sidecar_ready() {
  curl -fsI http://localhost:15021/healthz/ready
}

# Function to gracefully shut down the sidecar
shutdown_sidecar() {
  curl -fsI -X POST http://localhost:15020/quitquitquit
}

# Wait for the sidecar to be ready with a timeout of 3 minutes (180 seconds)
timeout=180
elapsed=0
interval=5

while ! check_sidecar_ready; do
  if [ $elapsed -ge $timeout ]; then
    echo "Sidecar did not become ready within 3 minutes."
    exit 1
  fi
  echo "Waiting for Sidecar..."
  sleep $interval
  elapsed=$((elapsed + interval))
done

echo "Sidecar available. Running the command..."

# Run the Go application
/opt/app/gocve
app_exit_code=$?

# Check if the application ran successfully
if [ $app_exit_code -ne 0 ]; then
  echo "Application exited with code $app_exit_code"
else
  echo "Application ran successfully"
fi

# Attempt to shut down the sidecar
if shutdown_sidecar; then
  echo "Sidecar shut down successfully"
else
  echo "Failed to shut down the sidecar"
  exit 1
fi

# Exit with the application's exit code
exit $app_exit_code